<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Reset password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
body {
font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
background: #f7f7f7;
display: flex;
align-items: center;
justify-content: center;
height: 100vh;
margin: 0;
}
.card {
background: #fff;
padding: 24px;
border-radius: 8px;
width: 100%;
max-width: 360px;
box-shadow: 0 8px 30px rgba(0,0,0,0.08);
}
h1 {
margin-top: 0;
margin-bottom: 16px;
font-size: 20px;
}
input {
width: 100%;
padding: 10px;
font-size: 14px;
margin-bottom: 12px;
box-sizing: border-box;
border: 1px solid #ddd;
border-radius: 4px;
}
button {
width: 100%;
padding: 10px;
font-size: 14px;
cursor: pointer;
background: #0066ff;
color: white;
border: none;
border-radius: 4px;
}
button:hover {
background: #0052cc;
}
button:disabled {
background: #ccc;
cursor: not-allowed;
}
.status {
margin-top: 12px;
font-size: 13px;
}
.error {
color: #c62828;
}
.success {
color: #2e7d32;
}
</style>
</head>
<body>
  <div class="card">
    <h1>Смена пароля</h1>
    <input
      id="password"
      type="password"
      placeholder="Новый пароль"
    />
    <input
      id="confirm"
      type="password"
      placeholder="Повторите пароль"
    />
    <button id="submitBtn" onclick="submit()">Сохранить</button>
    <div id="status" class="status"></div>
  </div>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
const SUPABASE_URL = 'https://pmkpgtbikgqjqxghmqed.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBta3BndGJpa2dxanF4Z2htcWVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NjgwNjMsImV4cCI6MjA4NTA0NDA2M30.p2lporubgIUqW0LvbMV0cqalh_n_kGEMLMh08PNz1GY'

const { createClient } = supabase
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// Проверяем наличие токенов при загрузке страницы
window.addEventListener('load', async () => {
  const status = document.getElementById('status')
  const hashParams = new URLSearchParams(window.location.hash.substring(1))
  const access_token = hashParams.get('access_token')
  
  if (!access_token) {
    status.textContent = 'Ссылка недействительна или устарела'
    status.classList.add('error')
    document.getElementById('submitBtn').disabled = true
    return
  }

  // Устанавливаем сессию
  const { error } = await supabaseClient.auth.setSession({
    access_token,
    refresh_token: hashParams.get('refresh_token')
  })

  if (error) {
    status.textContent = 'Ошибка: ' + error.message
    status.classList.add('error')
    document.getElementById('submitBtn').disabled = true
  }
})

async function submit() {
  const password = document.getElementById('password').value
  const confirm = document.getElementById('confirm').value
  const status = document.getElementById('status')
  const btn = document.getElementById('submitBtn')
  
  status.textContent = ''
  status.className = 'status'
  
  if (password.length < 6) {
    status.textContent = 'Пароль должен быть не короче 6 символов'
    status.classList.add('error')
    return
  }
  
  if (password !== confirm) {
    status.textContent = 'Пароли не совпадают'
    status.classList.add('error')
    return
  }

  btn.disabled = true
  btn.textContent = 'Сохранение...'

  const { error } = await supabaseClient.auth.updateUser({
    password,
  })
  
  if (error) {
    status.textContent = 'Ошибка: ' + error.message
    status.classList.add('error')
    btn.disabled = false
    btn.textContent = 'Сохранить'
  } else {
    status.textContent = 'Пароль успешно изменён ✅'
    status.classList.add('success')
    btn.textContent = 'Готово'
    
    // Опционально: редирект на страницу входа через 2 секунды
    // setTimeout(() => window.location.href = '/login.html', 2000)
  }
}
</script>
</body>
</html>